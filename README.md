# ListMaster Service

## Содержание

- [Описание](#описание)
- [Стек](#стек)
- [Установка](#установка)
- [База данных](#база-данных)
- [Аутентификация и авторизация](#аутентификация-и-авторизация)
- [Описание API](#описание-api)


## Описание

Это серверная часть приложения ListMaster (https://github.com/cyber1311/ListMaster) для планирования и управления списками для ОС iOS.

Приложение позволяет:

•	Регистрироваться новым пользователям

•	Авторизироваться зарегистрированным пользователям

•	Создавать, удалять и редактировать списки

•	Вести одновременно несколько списков

•	Создавать, удалять и редактировать группы пользователей

•	Делиться копией списка с другими пользователями или группами пользователей

•	Совместно редактировать список с другими пользователями или группами пользователей

•	Добавлять к пунктам списка изображения, дедлайн и напоминание


## Стек:

•	C#

•	PostgreSQL

•	ASP.NET Core

•	Dapper

•	Npgsql

## Установка

1. Клонируйте репозиторий:
   
   ```bash
   git clone https://github.com/cyber1311/ListMasterService.git

2. Перейдите в директорию проекта:

   ```bash
   cd ListMasterService

3. Создайте базу данных по схеме из файла database.sql

4. Настройте подключение к базе данных в файле appsettings.json.

5. Запустите приложение:

   ```bash
   dotnet run

После установки и запуска серверной части, приложение доступно по адресу http://localhost:5211

## База данных

Все необходимые для приложения данные можно организовать в пять таблиц. 

<img width="468" alt="image" src="https://github.com/cyber1311/ListMasterService/assets/80820085/8dbebfb4-f780-44c7-bc4b-e8e509d0820e">

Для хранения данных о пользователях используется таблица users (идентификатор, имя, электронная почта и пароль). Для хранения данных о списках используется таблица lists (идентификатор списка, название списка, пункты списка, доступность для редактирования другими пользователями, идентификатор владельца списка), смежная таблица users_lists, чтобы связать пользователей и списки. Для хранения данных о группах пользователей используется таблица groups (идентификатор группы, название группы, идентификатор владельца группы), смежная таблица users_groups, чтобы связать пользователей и группы. Также используется файловая система сервера для хранения изображений, использующихся в списках.

## Аутентификация и авторизация

Для работы с данными также необходима система аутентификации и авторизации, чтобы пользователь мог работать только со своими данными и не мог редактировать чужие. Для этого в проекте используются JSON Web Token (JWT) токены. Сервер генерирует токены, подписывает их секретным ключом и передает их клиентам. В дальнейшем клиент при обращении к серверу предоставляет сгенерированный токен для подтверждения подлинности своего аккаунта. В HTTP-запросе JWT токен находится в заголовке «Authorization».

## Описание API

### Управление пользователями

#### Создание нового пользователя
POST /users/add_user

По этому пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор, электронная почта, имя и пароль пользователя. 

Если запрос некорректен или уже существует пользователь с такой электронной почтой, то клиенту возвращается сообщение об ошибке запроса. Если запрос корректен, то в таблицу users добавляется новый пользователь и для этого пользователя генерируется JWT токен и возвращается клиенту.

#### Удаление пользователя
DELETE /users/delete_user

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимым для удаления параметром — идентификатором пользователя.

При некорректном JWT токене возвращается ошибка авторизации. Если запрос будет корректен, то пользователь будет удален из таблицы users, а также будут удалены все списки, для которых он является владельцем, из таблицы lists, все записи из таблицы users_lists и users_groups, где указан идентификатор удаляемого пользователя, и все группы, для которых он является владельцем, из таблицы groups.

#### Подтверждение почты для нового пользователя
GET /users/email_verification

По этому пути клиент отправляет HTTP-запрос с необходимым параметром — электронной почтой нового пользователя. 

Если в таблице users существует пользователь с указанными электронной почтой и паролем, то клиенту возвращается ответ с ошибкой запроса. Иначе клиенту вернется проверочный код, и он же будет отправлен на указанную электронную почту.

#### Подтверждение почты для восстановления пароля
GET /users/forget_password

По этому пути клиент отправляет HTTP-запрос с необходимым параметром — электронной почтой пользователя. 

Если в таблице users существует пользователь с указанными электронной почтой, то клиенту возвращается проверочный код, и он же отправляется на указанную электронную почту. Иначе возвращается ответ с ошибкой запроса.

#### Восстановления доступа к аккаунту
GET /users/restore_access

По этому пути клиент отправляет HTTP-запрос с необходимыми для входа параметрами — электронной почтой и новым паролем пользователя

Если в таблице users существует пользователь с указанной электронной почтой, то клиенту возвращается ответ в JSON формате с атрибутами: идентификатор, имя и JWT токен пользователя. Иначе возвращается ответ с ошибкой запроса.

#### Вход в аккаунт
GET /users/sign_in

По этому пути клиент отправляет HTTP-запрос с необходимыми для входа параметрами — электронной почтой и паролем пользователя. 

Если в таблице users существует пользователь с указанными электронной почтой и паролем, то клиенту возвращается ответ в JSON формате с атрибутами: идентификатор, имя и JWT токен пользователя. Иначе возвращается ответ с ошибкой запроса.

#### Обновление имени/пароля/электронной почты пользователя
PUT /users/update_user_name

PUT /users/update_user_password

PUT /users/update_user_email

По каждому из этих маршрутов клиент может отправить HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор и новое имя/новый пароль/новая электронная почта пользователя, а также с заголовком Authorization, в котором указан JWT токен.

Если в заголовке Authorization будет указан некорректный или чужой JWT токен или заголовок будет отсутствовать, то клиенту вернется сообщение об ошибке авторизации. Если запрос будет корректен, то в таблицу users будет внесено обновление.

### Управление группами пользователей

#### Создание новой группы
POST /groups/add_group

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор группы, название и идентификатор владельца, и с заголовком Authorization, в котором указан JWT токен.

Если запрос корректен и пройдена авторизация, то в таблицу groups добавляется новая группа, а в таблицу users_groups — новая запись, связывающая идентификатор владельца группы и идентификатор группы. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Добавление пользователя в группу
POST /groups/add_group_member

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор группы, идентификатор владельца и идентификатор пользователя, которого нужно добавить в группу, и с заголовком Authorization, в котором указан JWT токен.

Если запрос корректен и пройдена авторизация, то в таблицу users_groups добавляется новая запись, связывающая идентификаторы пользователя и группы. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Удаление группы
DELETE /groups/delete_group

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для удаления параметрами — идентификатором владельца группы и идентификатором группы.

При корректном запросе и пройденной авторизации группа удаляется из таблицы groups и удаляются все записи из таблицы users_groups с полученным из запроса идентификатором группы. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Удаление пользователя из группы
DELETE /groups/delete_group_member

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для удаления параметрами — идентификатором группы, идентификатором владельца и идентификатором пользователя, которого нужно удалить из группы. Если пользователь сам покидает группу, то вместо идентификатора владельца повторно используется идентификатор пользователя, которого нужно удалить из группы.

При корректном запросе и пройденной авторизации из таблицы users_groups удаляется запись, связывающая идентификаторы пользователя и группы. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Обновление названия группы
PUT /groups/update_group_title

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор владельца группы, идентификатор группы и новое название группы, а также с заголовком Authorization, в котором указан JWT токен.

При корректном запросе и пройденной авторизации в таблицу groups вносится обновление. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Получение всех участников группы
GET /groups/get_all_group_members

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для получения участников группы параметрами — идентификатором владельца группы и идентификатором группы.

При корректном запросе и пройденной авторизации клиенту возвращается массив пользователей, состоящих из идентификатора, имени и электронной почты, в JSON формате. Иначе возвращается ответ с ошибкой запроса или ошибкой авторизации.

#### Получение всех групп пользователя
GET /groups/get_all_user_groups

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимым для получения участников группы параметром — идентификатором пользователя.

При корректном запросе и пройденной авторизации клиенту возвращается массив групп, состоящих из идентификатора группы, названия и идентификатора владельца группы, в JSON формате. Иначе возвращается ответ с ошибкой запроса или ошибкой авторизации.

### Управление списками

#### Создание нового списка
POST /lists/add_list

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор пользователя, идентификатор, название, пункты списка, доступность для совместного редактирования и идентификатор владельца, и с заголовком Authorization, в котором указан JWT токен.

Если запрос корректен и пройдена авторизация, то в таблицу lists добавляется новый список, а в таблицу users_lists — новая запись, связывающая идентификаторы пользователя и списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Обновление названия/пунктов списка
PUT /lists/update_list_title

PUT /lists/update_list_elements

По каждому из этих маршрутов клиент может отправить HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор пользователя, идентификатор и новое название/новые пункты списка, а также с заголовком Authorization, в котором указан JWT токен.

При корректном запросе и пройденной авторизации в таблицу lists вносятся обновления. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Удаление списка
DELETE /lists/delete_list

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для удаления параметрами — идентификатором пользователя и идентификатором списка.

При корректном запросе и пройденной авторизации список удаляется из таблицы users_lists, а также из таблицы lists, если пользователь является владельцем этого списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Получение списка
GET /lists/get_list

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для получения списка параметрами — идентификатором пользователя и идентификатором списка.

При корректном запросе и пройденной авторизации клиенту возвращается список, состоящий из идентификатора списка, названия, пунктов, доступности для совместного редактирования и идентификатора владельца, в JSON формате. Иначе возвращается ответ с ошибкой запроса или ошибкой авторизации.

#### Получение всех списков пользователя
GET /lists/get_all_user_lists

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимым для получения списков параметром — идентификатором пользователя.

При корректном запросе и пройденной авторизации клиенту возвращается массив списков, состоящих из идентификатора списка, названия, пунктов, доступности для совместного редактирования и идентификатора владельца, в JSON формате. Иначе возвращается ответ с ошибкой запроса или ошибкой авторизации.

#### Копирование списка
POST /lists/copy_list

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор пользователя, чей список копируют, идентификатор пользователя, который получит список-дубликат, идентификатор списка, который копируют, и идентификатор нового списка-дубликата, и с заголовком Authorization, в котором указан JWT токен пользователя, чей список копируют.

При корректном запросе и пройденной авторизации в таблицу lists добавляется список-дубликат, а в таблицу users_lists — новая запись, связывающая идентификаторы пользователя и списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Предоставление возможности совместного редактирования списка
POST /lists/share_list

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор пользователя-владельца, идентификатор пользователя, который получит права редактировать список, идентификатор списка, и с заголовком Authorization, в котором указан JWT токен пользователя-владельца.

При корректном запросе и пройденной авторизации в таблицу users_lists добавляется новая запись, связывающая идентификаторы списка и пользователя, которому дали права на редактирование списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации

#### Удаление совместного доступа
DELETE /lists/delete_list_share

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для удаления параметрами — идентификатором владельца списка и идентификатором списка.

При корректном запросе и пройденной авторизации из таблицы users_lists удаляются записи, где идентификатор пользователя не равен идентификатору владельца списка, а также обновляется доступность для совместного редактирования у списка в таблице lists — список больше не доступен никому, кроме владельца. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Удаление доступа к списку у конкретного пользователя
DELETE /lists/cancel_share_for_user

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для удаления параметрами — идентификатором владельца списка, идентификатором пользователя, у которого будет удален доступ к списку, и идентификатором списка.

При корректном запросе и пройденной авторизации из таблицы users_lists удаляется запись с полученными из запроса идентификаторами пользователя и списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Дублирование списка
POST /lists/duplicate_list

По указанному пути клиент отправляет HTTP-запрос с телом в формате JSON, где его атрибутами являются идентификатор пользователя, идентификатор списка, который дублируют, и идентификатор нового списка-дубликата, и с заголовком Authorization, в котором указан JWT токен.

При корректном запросе и пройденной авторизации в таблицу lists добавляется список-дубликат, а в таблицу users_lists — новая запись, связывающая идентификаторы пользователя и списка. Иначе клиенту возвращается ошибка запроса или ошибка авторизации.

#### Получение всех пользователей списка
GET /lists/get_all_list_users

По указанному пути клиент отправляет HTTP-запрос с заголовком Authorization, в котором указан JWT токен, и с необходимыми для получения пользователей параметрами — идентификатором владельца списка и идентификатором списка.

При корректном запросе и пройденной авторизации клиенту возвращается массив пользователей, состоящих из идентификатора, имени и электронной почты пользователя, в JSON формате. Иначе возвращается ответ с ошибкой запроса или ошибкой авторизации.

### Управление изображениями

#### Загрузка изображения
POST /images/upload

По указанному пути клиент отправляет HTTP-запрос с прикрепленным файлом изображения.

При корректном запросе в файловую систему сервера добавляется новое изображение. Иначе клиенту возвращается ошибка запроса.

#### Скачивание изображения
GET /images/download

По указанному пути клиент отправляет HTTP-запрос с необходимым для получения изображения параметром — названием изображения.

При корректном запросе клиенту возвращается изображение, иначе — ошибка запроса.

#### Удаление изображения
DELETE /images/delete

По указанному пути клиент отправляет HTTP-запрос с необходимым для удаления изображения параметром — названием изображения.

При корректном запросе изображение удаляется, иначе — ошибка запроса.






